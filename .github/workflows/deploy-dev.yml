# Workflow name displayed in GitHub Actions UI
# Learn more: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#name
name: Deploy to Development

# Required Secrets Configuration:
# GitHub Encrypted Secrets allow secure storage of sensitive information
# Learn more: https://docs.github.com/en/actions/security-guides/encrypted-secrets
#
# Navigate to Settings > Secrets and variables > Actions > New repository secret
# Add the following secrets:
#   - AZURE_CLIENT_ID: Service Principal Client ID for workload identity federation
#   - AZURE_TENANT_ID: Azure AD (Entra ID) Tenant ID
#   - AZURE_SUBSCRIPTION_ID: Target Azure Subscription ID
# 
# Also create 'dev' environment in Settings > Environments for deployment protection rules
# Learn more: https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment
# Azure OIDC Authentication: https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure

# Workflow triggers define when this workflow executes
# Learn more: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows
on:
  # Trigger on push to dev branch with path filters for efficient CI/CD
  # Path filters: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onpushpull_requestpull_request_targetpathspaths-ignore
  push:
    branches:
      - dev
    paths:
      - 'bicep/**'
      - 'parameters/dev.bicepparam'
      - 'app/**'
      - '.github/workflows/deploy-dev.yml'
  # Allow manual workflow execution from GitHub Actions UI
  # Learn more: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch
  workflow_dispatch:

# Workflow permissions control what the GITHUB_TOKEN can access
# Learn more: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
permissions:
  # Required for OIDC authentication with Azure (federated credentials)
  # Learn more: https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect
  id-token: write
  # Required to checkout repository code
  contents: read

# Environment variables available to all jobs in this workflow
# Learn more: https://docs.github.com/en/actions/learn-github-actions/variables#defining-environment-variables-for-a-single-workflow
env:
  ENVIRONMENT: dev

# Jobs define the work to be done in this workflow
# Jobs run in parallel by default unless dependencies are specified with 'needs'
# Learn more: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobs
jobs:
  # Validation job ensures Bicep templates are valid before deployment
  validate:
    name: Validate Infrastructure
    # Runner specifies the VM image to execute the job
    # Learn more: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on
    runs-on: ubuntu-latest
    # Environment provides deployment protection rules, secrets, and variables
    # Uncomment the line below after creating 'dev' environment in GitHub repo settings
    # Learn more: https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment
    # environment: dev
    steps:
      # Checkout action clones repository code to the runner
      # Learn more: https://github.com/actions/checkout
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Region from Parameters
        id: get-region
        run: |
          REGION=$(grep "param primaryRegion" parameters/${{ env.ENVIRONMENT }}.bicepparam | sed "s/.*= '\(.*\)'/\1/")
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "Extracted region: $REGION"

      # Azure Login using OpenID Connect (OIDC) for secure, passwordless authentication
      # No client secrets needed - uses federated identity credentials
      # Learn more: https://github.com/Azure/login
      # Azure OIDC Setup: https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Validate Bicep deployment without making changes (dry-run validation)
      # Azure CLI deployment validate: https://learn.microsoft.com/en-us/cli/azure/deployment/sub#az-deployment-sub-validate
      # Bicep deployment commands: https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/deploy-cli
      - name: Validate Bicep Deployment
        working-directory: .
        run: |
          echo "Validating deployment for ${{ env.ENVIRONMENT }}..."
          
          # Validate subscription-level deployment
          # --location: Azure region for deployment metadata
          # --template-file: Path to main Bicep template
          # --parameters: Bicep parameter file and inline parameter overrides
          az deployment sub validate \
            --location ${{ steps.get-region.outputs.region }} \
            --template-file bicep/main.bicep \
            --parameters parameters/${{ env.ENVIRONMENT }}.bicepparam \
            --parameters deployedBy="${{ github.actor }}" \
            --parameters deployedDate="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          
          echo "Validation successful"

  # Infrastructure deployment job creates Azure resources using Bicep
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    # Job dependencies - this job runs only after validate completes successfully
    # Learn more: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idneeds
    needs: validate
    # Uncomment the line below after creating 'dev' environment in GitHub repo settings
    # environment: dev
    # Job outputs allow passing data to dependent jobs
    # Learn more: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idoutputs
    outputs:
      webAppName: ${{ steps.deploy.outputs.webAppName }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Region from Parameters
        id: get-region
        run: |
          REGION=$(grep "param primaryRegion" parameters/${{ env.ENVIRONMENT }}.bicepparam | sed "s/.*= '\(.*\)'/\1/")
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "Extracted region: $REGION"

      # Azure Login using OIDC for secure authentication
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Deploy infrastructure to Azure using Bicep templates
      # Azure CLI deployment create: https://learn.microsoft.com/en-us/cli/azure/deployment/sub#az-deployment-sub-create
      # Bicep deployment guide: https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/deploy-cli
      - name: Deploy Infrastructure
        id: deploy
        working-directory: .
        run: |
          echo "Deploying infrastructure to ${{ env.ENVIRONMENT }}..."
          
          # Create unique deployment name with timestamp for tracking
          DEPLOYMENT_NAME="webapp-${{ env.ENVIRONMENT }}-$(date +%Y%m%d-%H%M%S)"
          
          # Execute subscription-level deployment
          # --name: Unique name for deployment tracking in Azure Portal
          # --output json: Return deployment results as JSON
          # Date command generates ISO 8601 timestamp: https://www.gnu.org/software/coreutils/manual/html_node/date-invocation.html
          az deployment sub create \
            --name "$DEPLOYMENT_NAME" \
            --location ${{ steps.get-region.outputs.region }} \
            --template-file bicep/main.bicep \
            --parameters parameters/${{ env.ENVIRONMENT }}.bicepparam \
            --parameters deployedBy="${{ github.actor }}" \
            --parameters deployedDate="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --output json > deployment-output.json
          
          # Extract deployment outputs using jq (JSON processor)
          # jq documentation: https://stedolan.github.io/jq/manual/
          # GitHub Actions output syntax: https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#setting-an-output-parameter
          WEB_APP_NAME=$(jq -r '.properties.outputs.webAppName.value' deployment-output.json)
          echo "webAppName=$WEB_APP_NAME" >> $GITHUB_OUTPUT
          
          echo "Infrastructure deployment complete"
          echo "Web App: $WEB_APP_NAME"

  # Application deployment job deploys Node.js application to Azure Web App
  deploy-application:
    name: Deploy Application
    runs-on: ubuntu-latest
    # Depends on infrastructure deployment to ensure resources exist
    needs: deploy-infrastructure
    # Uncomment the line below after creating 'dev' environment in GitHub repo settings
    # environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Region from Parameters
        id: get-region
        run: |
          REGION=$(grep "param primaryRegion" parameters/${{ env.ENVIRONMENT }}.bicepparam | sed "s/.*= '\(.*\)'/\1/")
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "Extracted region: $REGION"

      # Setup Node.js environment for building/packaging application
      # Learn more: https://github.com/actions/setup-node
      # Node.js versions: https://nodejs.org/en/about/releases/
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Install npm dependencies defined in package.json
      # npm install documentation: https://docs.npmjs.com/cli/v9/commands/npm-install
      - name: Install dependencies
        working-directory: app
        run: npm install

      # Azure Login for deployment operations
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Deploy application package to Azure Web App using ZIP deployment
      # ZIP deployment is fast and atomic (all-or-nothing)
      # Azure CLI webapp deployment: https://learn.microsoft.com/en-us/cli/azure/webapp/deployment/source#az-webapp-deployment-source-config-zip
      # ZIP Deploy guide: https://learn.microsoft.com/en-us/azure/app-service/deploy-zip
      - name: Deploy to Web App
        working-directory: app
        run: |
          # Access output from previous job using needs context
          # Learn more: https://docs.github.com/en/actions/learn-github-actions/contexts#needs-context
          echo "Deploying application to ${{ needs.deploy-infrastructure.outputs.webAppName }}..."
          
          # Create ZIP archive of application files
          zip -r app.zip .
          
          # Deploy ZIP to Azure Web App
          # --resource-group: Target resource group name
          # --name: Target Web App name from previous job output
          # --src: Path to ZIP file
          az webapp deployment source config-zip \
            --resource-group rg-${{ steps.get-region.outputs.region }}-${{ env.ENVIRONMENT }}-webapp \
            --name ${{ needs.deploy-infrastructure.outputs.webAppName }} \
            --src app.zip
          
          echo "Application deployment complete"

  # Smoke tests perform basic validation of deployed application
  # Smoke testing verifies critical functionality works after deployment
  # Learn more: https://en.wikipedia.org/wiki/Smoke_testing_(software)
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    # Run after both infrastructure and application are deployed
    needs: [deploy-infrastructure, deploy-application]
    steps:
      # Azure Login for accessing deployed resources
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Execute basic health checks on deployed application
      # curl documentation: https://curl.se/docs/manpage.html
      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests..."
          
          # Construct Web App URL using default Azure domain
          # Azure App Service domains: https://learn.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-custom-domain
          WEB_APP_URL="https://${{ needs.deploy-infrastructure.outputs.webAppName }}.azurewebsites.net"
          
          # Test health endpoint (note: may fail if using private endpoint only)
          # curl flags: -f (fail on HTTP errors), -s (silent mode)
          echo "Testing health endpoint..."
          # curl -f -s "$WEB_APP_URL/health" || echo "Health check failed (expected for private endpoint)"
          
          echo "Smoke tests complete"

  # Summary job creates deployment summary in GitHub Actions UI
  # Job summary markdown: https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#adding-a-job-summary
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    # Run after all deployment jobs complete
    needs: [deploy-infrastructure, deploy-application, smoke-tests]
    # Always run summary even if previous jobs fail
    # Conditional execution: https://docs.github.com/en/actions/learn-github-actions/expressions#status-check-functions
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Region from Parameters
        id: get-region
        run: |
          REGION=$(grep "param primaryRegion" parameters/${{ env.ENVIRONMENT }}.bicepparam | sed "s/.*= '\(.*\)'/\1/")
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "Extracted region: $REGION"

      # Create markdown summary in GitHub Actions UI
      # GITHUB_STEP_SUMMARY environment file: https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#adding-a-job-summary
      - name: Create Summary
        run: |
          # Append markdown content to step summary file
          echo "## Development Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ steps.get-region.outputs.region }}" >> $GITHUB_STEP_SUMMARY
          # github.actor provides the username that triggered the workflow
          # GitHub contexts: https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
          echo "- **Deployed By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Web App**: ${{ needs.deploy-infrastructure.outputs.webAppName }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          # Access job results from needs context
          # Job status values: success, failure, cancelled, skipped
          echo "- Infrastructure: ${{ needs.deploy-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Application: ${{ needs.deploy-application.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke Tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
